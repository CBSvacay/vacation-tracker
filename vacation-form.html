<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vacation Selection Form</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        * {
            box-sizing: border-box;
        }
        
        .container-lg {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .info-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
            flex: 1;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-warning {
            background: #ffc107;
            color: #000;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
            display: none;
            width: 100%;
            padding: 15px;
            font-size: 18px;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        #calendarSection {
            display: none;
            margin-top: 25px;
        }
        
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }
        
        .calendar-controls button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        .calendar-controls button:hover {
            background: #5568d3;
        }
        
        #monthTitle {
            font-size: 22px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        #calendarGrid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .calendar-header {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            border: 2px solid #dee2e6;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: 600;
        }
        
        .calendar-day:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .calendar-day.disabled {
            cursor: not-allowed;
            opacity: 0.3;
        }
        
        .calendar-day.work-empty {
            background: #9e9e9e;
            border-color: #424242;
            color: white;
            font-weight: bold;
        }

        .calendar-day.work-partial {
            background: #ffc107;
            border-color: #f57c00;
            color: #000;
            font-weight: bold;
        }

        .calendar-day.work-full {
            background: #dc3545;
            border-color: #b71c1c;
            color: white;
            font-weight: bold;
            cursor: not-allowed;
        }

        .calendar-day.nonwork-empty,
        .calendar-day.nonwork-partial,
        .calendar-day.nonwork-full {
            background: #e3f2fd;
            border-color: #90caf9;
            color: #000;
        }

        .calendar-day.nonwork-full {
            cursor: not-allowed;
        }
        
        .calendar-day.previous-selection {
            background: #2196F3;
            border: 3px solid #1565C0;
            color: white;
            font-weight: bold;
        }

        .calendar-day.previous-selection:hover {
            background: #1976D2;
        }
        
        .calendar-day.selected {
            border: 3px solid #667eea;
            background: #667eea !important;
            color: white;
            font-weight: bold;
        }
        
        #selectionSummary {
            display: none;
            background: #d4edda;
            border: 2px solid #28a745;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        #selectionSummary h3 {
            margin-top: 0;
            color: #155724;
        }
        
        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            border: 2px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container-lg px-3 my-5 markdown-body">
        <h1>Annual Vacation Selection</h1>
        
        <div class="info-card">
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Employee Name</span>
                    <span class="info-value" id="employeeName">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Seniority Rank</span>
                    <span class="info-value" id="seniorityRank">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Available Days</span>
                    <span class="info-value" id="availableDays">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Current Round</span>
                    <span class="info-value" id="currentRound">-</span>
                </div>
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="showCalendar()">Select Vacation Dates</button>
            <button class="btn btn-warning" onclick="skipRound()">Skip This Round</button>
            <button class="btn btn-danger" onclick="endSelection()">End Selection</button>
        </div>
        
        <div id="calendarSection">
            <div class="calendar-controls">
                <button onclick="previousMonth()">← Previous</button>
                <span id="monthTitle">January 2026</span>
                <button onclick="nextMonth()">Next →</button>
            </div>
            
            <div id="calendarGrid"></div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #2196F3; border: 3px solid #1565C0;"></div>
                    <span>Your Previous Selection</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #9e9e9e; border-color: #424242;"></div>
                    <span>Available Work Day</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffc107; border-color: #f57c00;"></div>
                    <span>Partially Booked Work Day</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #dc3545; border-color: #b71c1c;"></div>
                    <span>Fully Booked (Blocked)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e3f2fd; border-color: #90caf9;"></div>
                    <span>Off Day</span>
                </div>
            </div>
            
            <div id="selectionSummary">
                <h3>Your Selection</h3>
                <p><strong>Start Date:</strong> <span id="startDate"></span></p>
                <p><strong>End Date:</strong> <span id="endDate"></span></p>
                <p><strong>Total Days:</strong> <span id="totalDays"></span></p>
                <p><strong>Days Remaining:</strong> <span id="remainingDays"></span></p>
            </div>
        </div>
        
        <button class="btn btn-success" id="submitBtn" onclick="submitSelection()">Submit Vacation Selection</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
    <script>
    let employeeData = {
        name: 'Test Employee',
        rank: 1,
        availableDays: 25,
        round: 1,
        unionMaxPerDay: 2
    };
    
    let currentMonth = 0;
    const urlParams = new URLSearchParams(window.location.search);
    let currentYear = parseInt(urlParams.get('year')) || 2026; 
    let selectedDates = [];
    let availability = {};
    let employeeSchedule = [];
    let previousSelections = [];
    let employeeLocations = {};
    let locationAvailability = {};
    let locationMaxes = {};
    
    const monthNames = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
    ];
    
    const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page loaded');
        parseURLParameters();
        updateEmployeeInfo();
        loadCalendarDataFromURL();
    });
    
    function parseURLParameters() {
        const urlParams = new URLSearchParams(window.location.search);
        employeeData.name = urlParams.get('name') || 'Test Employee';
        employeeData.rank = parseInt(urlParams.get('rank')) || 1;
        employeeData.availableDays = parseInt(urlParams.get('days')) || 25;
        employeeData.round = parseInt(urlParams.get('round')) || 1;
        employeeData.unionMaxPerDay = parseInt(urlParams.get('maxperday')) || 2;
        
        const scheduleParam = urlParams.get('schedule');
        if (scheduleParam && scheduleParam !== '') {
            const scheduleParts = scheduleParam.split(',');
            scheduleParts.forEach(part => {
                if (part.includes(':')) {
                    const [date, location] = part.split(':');
                    employeeSchedule.push(date);
                    employeeLocations[date] = location;
                } else {
                    employeeSchedule.push(part);
                }
            });
        }
        
        const previousParam = urlParams.get('previous');
        if (previousParam && previousParam !== '') {
            const rounds = previousParam.split(',');
            rounds.forEach(roundData => {
                const parts = roundData.split(':');
                if (parts.length === 2) {
                    const dates = parts[1].split('-');
                    if (dates.length === 6) {
                        const startDate = `${dates[0]}-${dates[1]}-${dates[2]}`;
                        const endDate = `${dates[3]}-${dates[4]}-${dates[5]}`;
                        
                        let current = new Date(startDate);
                        const end = new Date(endDate);
                        
                        while (current <= end) {
                            const dateStr = current.toISOString().split('T')[0];
                            if (employeeSchedule.includes(dateStr)) {
                                previousSelections.push(dateStr);
                            }
                            current.setDate(current.getDate() + 1);
                        }
                    }
                }
            });
        }
        
        console.log('Employee data:', employeeData);
        console.log('Employee schedule:', employeeSchedule);
        console.log('Employee locations:', employeeLocations);
        console.log('Previous selections:', previousSelections);
    }
    
    function loadCalendarDataFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const calParam = urlParams.get('cal');
        
        availability = {};
        locationAvailability = {};
        
        if (calParam && calParam !== '') {
            const entries = calParam.split(',');
            entries.forEach(entry => {
                const parts = entry.split(':');
                
                if (parts.length >= 2) {
                    const date = parts[0];
                    const totalCount = parseInt(parts[1]);
                    availability[date] = totalCount;
                    
                    if (parts.length >= 3) {
                        locationAvailability[date] = {};
                        
                        const locationData = parts.slice(2).join(':');
                        const locationPairs = locationData.split(',');
                        
                        locationPairs.forEach(pair => {
                            const [loc, count] = pair.split(':');
                            if (loc && count) {
                                locationAvailability[date][loc] = parseInt(count);
                            }
                        });
                    }
                }
            });
        }
        
        const maxesParam = urlParams.get('locationmaxes');
        if (maxesParam && maxesParam !== '') {
            const maxPairs = maxesParam.split(',');
            maxPairs.forEach(pair => {
                const [loc, max] = pair.split(':');
                if (loc && max) {
                    locationMaxes[loc] = parseInt(max);
                }
            });
        }
        
        console.log('Calendar availability:', availability);
        console.log('Location availability:', locationAvailability);
        console.log('Location maxes:', locationMaxes);
    }
    
    function updateEmployeeInfo() {
        document.getElementById('employeeName').textContent = employeeData.name;
        document.getElementById('seniorityRank').textContent = employeeData.rank;
        document.getElementById('availableDays').textContent = employeeData.availableDays;
        document.getElementById('currentRound').textContent = employeeData.round;
        document.getElementById('remainingDays').textContent = employeeData.availableDays;
    }
    
    function countWorkDaysInSelection(dateArray) {
        if (employeeSchedule.length === 0) {
            return dateArray.length;
        }
        
        let workDayCount = 0;
        dateArray.forEach(dateStr => {
            if (employeeSchedule.includes(dateStr)) {
                workDayCount++;
            }
        });
        return workDayCount;
    }
    
    function showCalendar() {
        console.log('showCalendar called');
        const calendarSection = document.getElementById('calendarSection');
        const submitBtn = document.getElementById('submitBtn');
        
        calendarSection.style.display = 'block';
        submitBtn.style.display = 'block';
        
        renderCalendar();
    }
    
    function skipRound() {
        if (confirm(`Skip Round ${employeeData.round}?\n\nYou'll remain eligible for future rounds.`)) {
            processAction('skip');
        }
    }
    
    function endSelection() {
        if (confirm(`End vacation selection permanently?\n\nYou will NOT be contacted for future rounds.`)) {
            processAction('end');
        }
    }
    
function processAction(action) {
    let emailBody, subject;
    
    if (action === 'skip') {
        subject = `Vacation Selection SKIPPED - ${employeeData.name} - Round ${employeeData.round}`;
        emailBody = `VACATION_SKIP
Name: ${employeeData.name}
Round: ${employeeData.round}
Action: Skipped

Employee chose to skip this round.`;
    } else {
        subject = `Vacation Selection ENDED - ${employeeData.name}`;
        emailBody = `VACATION_END
Name: ${employeeData.name}
Round: ${employeeData.round}
Action: Ended

Employee chose to end all future vacation selections.`;
    }
    
    const adminEmail = 'Your Supervisors';
    const fullText = `To: ${adminEmail}\nSubject: ${subject}\n\n${emailBody}`;
    
    // Copy to clipboard
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(fullText)
            .then(() => {
                alert(`✓ ${action === 'skip' ? 'Skip notification' : 'End selection'} copied to clipboard!\n\nPaste this into a new email to your supervisors.`);
            })
            .catch(err => {
                // Fallback if clipboard fails
                prompt('Copy this text and email to your supervisors:', fullText);
            });
    } else {
        // Fallback for browsers without clipboard support
        prompt('Copy this text and email to your supervisors:', fullText);
    }
}    
    function renderCalendar() {
        console.log('renderCalendar called');
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        
        document.getElementById('monthTitle').textContent = `${monthNames[currentMonth]} ${currentYear}`;
        
        dayNames.forEach(day => {
            const header = document.createElement('div');
            header.className = 'calendar-header';
            header.textContent = day;
            grid.appendChild(header);
        });
        
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        
        for (let i = 0; i < firstDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day disabled';
            grid.appendChild(emptyDay);
        }
        
        // Check if we have location tracking enabled (locationMaxes has data)
        const hasLocationTracking = Object.keys(locationMaxes).length > 0;
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            
            const dateString = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
            const isWorkDay = employeeSchedule.includes(dateString);
            const employeeLocation = employeeLocations[dateString] || null;
            
            let bookedCount = 0;
            let maxPerDay = employeeData.unionMaxPerDay;
            
            if (isWorkDay && hasLocationTracking && employeeLocation && employeeLocation !== 'UNKNOWN') {
                // Use location-specific data
                if (locationAvailability[dateString] && locationAvailability[dateString][employeeLocation] !== undefined) {
                    bookedCount = locationAvailability[dateString][employeeLocation];
                }
                if (locationMaxes[employeeLocation] !== undefined) {
                    maxPerDay = locationMaxes[employeeLocation];
                }
            } else if (isWorkDay) {
                // Fallback to total count if no location tracking
                bookedCount = availability[dateString] || 0;
            }
            
            const isPreviousSelection = previousSelections.includes(dateString);
            
            if (isPreviousSelection) {
                dayElement.classList.add('previous-selection');
            } else if (isWorkDay) {
                if (bookedCount >= maxPerDay) {
                    dayElement.classList.add('work-full');
                } else if (bookedCount > 0) {
                    dayElement.classList.add('work-partial');
                } else {
                    dayElement.classList.add('work-empty');
                }
            } else {
                dayElement.classList.add('nonwork-empty');
            }
            
            if (selectedDates.includes(dateString)) {
                dayElement.classList.add('selected');
            }
            
            dayElement.innerHTML = `
                <div>${day}</div>
                <div style="font-size: 10px;">${bookedCount}/${maxPerDay}</div>
            `;
            
            dayElement.addEventListener('click', () => selectDate(dateString, dayElement, isWorkDay, bookedCount, maxPerDay));
            grid.appendChild(dayElement);
        }
    }
    
    function selectDate(dateString, element, isWorkDay, bookedCount, maxPerDay) {
        if (element && bookedCount >= maxPerDay) {
            alert('This work day is fully booked!');
            return;
        }
        
        if (selectedDates.length === 0) {
            selectedDates.push(dateString);
        } else if (selectedDates.length === 1) {
            const start = new Date(selectedDates[0]);
            const end = new Date(dateString);
            
            if (end < start) {
                selectedDates = [dateString, selectedDates[0]];
            } else {
                selectedDates.push(dateString);
            }
            
            fillConsecutiveDates();
        } else {
            selectedDates = [dateString];
        }
        
        renderCalendar();
        updateSelectionSummary();
    }
    
    function fillConsecutiveDates() {
        const start = new Date(selectedDates[0]);
        const end = new Date(selectedDates[selectedDates.length - 1]);
        const range = [];
        
        // Check if we have location tracking enabled
        const hasLocationTracking = Object.keys(locationMaxes).length > 0;
        
        let current = new Date(start);
        while (current <= end) {
            const dateStr = current.toISOString().split('T')[0];
            const isWorkDay = employeeSchedule.includes(dateStr);
            const employeeLocation = employeeLocations[dateStr] || null;
            
            let booked = 0;
            let maxForDay = employeeData.unionMaxPerDay;
            
            if (isWorkDay && hasLocationTracking && employeeLocation && employeeLocation !== 'UNKNOWN') {
                // Use location-specific data
                if (locationAvailability[dateStr] && locationAvailability[dateStr][employeeLocation] !== undefined) {
                    booked = locationAvailability[dateStr][employeeLocation];
                }
                if (locationMaxes[employeeLocation] !== undefined) {
                    maxForDay = locationMaxes[employeeLocation];
                }
            } else if (isWorkDay) {
                // Fallback to total count
                booked = availability[dateStr] || 0;
            }
            
            if (isWorkDay && booked >= maxForDay) {
                alert(`Cannot select range: ${dateStr} is a fully booked work day.`);
                selectedDates = [];
                return;
            }
            
            range.push(dateStr);
            current.setDate(current.getDate() + 1);
        }
        
        const workDaysInRange = countWorkDaysInSelection(range);
        
        if (workDaysInRange > employeeData.availableDays) {
            alert(`Selection includes ${workDaysInRange} work days but you only have ${employeeData.availableDays} vacation days remaining.`);
            selectedDates = [];
            return;
        }
        
        selectedDates = range;
    }
    
    function updateSelectionSummary() {
        const summary = document.getElementById('selectionSummary');
        
        if (selectedDates.length === 0) {
            summary.style.display = 'none';
            document.getElementById('submitBtn').disabled = true;
            return;
        }
        
        const workDays = countWorkDaysInSelection(selectedDates);
        
        summary.style.display = 'block';
        document.getElementById('submitBtn').disabled = false;
        
       // Fix: Parse dates as local dates to avoid timezone shift
const startDateParts = selectedDates[0].split('-');
const endDateParts = selectedDates[selectedDates.length - 1].split('-');

document.getElementById('startDate').textContent = new Date(startDateParts[0], startDateParts[1] - 1, startDateParts[2]).toLocaleDateString();
document.getElementById('endDate').textContent = new Date(endDateParts[0], endDateParts[1] - 1, endDateParts[2]).toLocaleDateString();
        document.getElementById('totalDays').textContent = `${selectedDates.length} total (${workDays} work days)`;
        document.getElementById('remainingDays').textContent = employeeData.availableDays - workDays;
    }
    
    function previousMonth() {
        if (currentMonth === 0) {
            currentMonth = 11;
            currentYear--;
        } else {
            currentMonth--;
        }
        renderCalendar();
    }
    
    function nextMonth() {
        if (currentMonth === 11) {
            currentMonth = 0;
            currentYear++;
        } else {
            currentMonth++;
        }
        renderCalendar();
    }
    
  function submitSelection() {
    if (selectedDates.length === 0) {
        alert('Please select your vacation dates first.');
        return;
    }
    
    const startDate = selectedDates[0];
    const endDate = selectedDates[selectedDates.length - 1];
    const totalDays = selectedDates.length;
    const workDays = countWorkDaysInSelection(selectedDates);
    
    const emailBodyText = `VACATION_SELECTION
Name: ${employeeData.name}
Start: ${startDate}
End: ${endDate}
Days: ${totalDays}
Work Days: ${workDays}
Round: ${employeeData.round}
This is an automated vacation selection submission.`;
    
    const emailSubject = `Vacation Selection - ${employeeData.name} - Round ${employeeData.round}`;
    const adminEmail = 'Your Supervisors';
    
    // Format dates for display WITHOUT timezone conversion
    const formatDateForDisplay = (dateStr) => {
        const [year, month, day] = dateStr.split('-');
        return new Date(year, month - 1, day).toLocaleDateString();
    };
    
    if (confirm(`You selected:\n\nStart: ${formatDateForDisplay(startDate)}\nEnd: ${formatDateForDisplay(endDate)}\nTotal Days: ${totalDays}\nWork Days: ${workDays}\n\nCopy email text to clipboard?`)) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(emailBodyText).then(() => {
                alert(`Email body copied to clipboard!\n\nNow:\n1. Open your email app\n2. Send new email to: ${adminEmail}\n3. Subject: ${emailSubject}\n4. Paste the copied text in the body\n5. Send`);
            }).catch(err => {
                prompt('Copy this text (Ctrl+C or Cmd+C):', emailBodyText);
                alert(`Send email to: ${adminEmail}\nSubject: ${emailSubject}`);
            });
        } else {
            prompt('Copy this text:', emailBodyText);
            alert(`Send email to: ${adminEmail}\nSubject: ${emailSubject}`);
        }
    }
}
    </script>
</body>
</html>





