<script>
    let employeeData = {
        name: 'Test Employee',
        rank: 1,
        availableDays: 25,
        round: 1,
        unionMaxPerDay: 2
    };
    
    let currentMonth = 0;
    let currentYear = 2026;
    let selectedDates = [];
    let availability = {};
    let employeeSchedule = [];
    
    const monthNames = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
    ];
    
    const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page loaded');
        parseURLParameters();
        updateEmployeeInfo();
        loadCalendarDataFromURL();
    });
    
    function parseURLParameters() {
        const urlParams = new URLSearchParams(window.location.search);
        employeeData.name = urlParams.get('name') || 'Test Employee';
        employeeData.rank = parseInt(urlParams.get('rank')) || 1;
        employeeData.availableDays = parseInt(urlParams.get('days')) || 25;
        employeeData.round = parseInt(urlParams.get('round')) || 1;
        employeeData.unionMaxPerDay = parseInt(urlParams.get('maxperday')) || 2;
        
        // Parse employee schedule
        const scheduleParam = urlParams.get('schedule');
        if (scheduleParam && scheduleParam !== '') {
            employeeSchedule = scheduleParam.split(',');
        }
        
        console.log('Employee data:', employeeData);
        console.log('Employee schedule:', employeeSchedule);
    }
    
    function updateEmployeeInfo() {
        document.getElementById('employeeName').textContent = employeeData.name;
        document.getElementById('seniorityRank').textContent = employeeData.rank;
        document.getElementById('availableDays').textContent = employeeData.availableDays;
        document.getElementById('currentRound').textContent = employeeData.round;
        document.getElementById('remainingDays').textContent = employeeData.availableDays;
    }
    
    function loadCalendarDataFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const calParam = urlParams.get('cal');
        
        availability = {};
        
        if (calParam && calParam !== '') {
            const entries = calParam.split(',');
            entries.forEach(entry => {
                const parts = entry.split(':');
                if (parts.length === 2) {
                    const date = parts[0];
                    const count = parseInt(parts[1]);
                    availability[date] = count;
                }
            });
        }
        console.log('Calendar availability:', availability);
    }
    
    function countWorkDaysInSelection(dateArray) {
        let workDayCount = 0;
        dateArray.forEach(dateStr => {
            if (employeeSchedule.includes(dateStr)) {
                workDayCount++;
            }
        });
        return workDayCount;
    }
    
    function showCalendar() {
        console.log('showCalendar called');
        const calendarSection = document.getElementById('calendarSection');
        const submitBtn = document.getElementById('submitBtn');
        
        calendarSection.style.display = 'block';
        submitBtn.style.display = 'block';
        
        renderCalendar();
    }
    
    function skipRound() {
        if (confirm(`Skip Round ${employeeData.round}?\n\nYou'll remain eligible for future rounds.`)) {
            processAction('skip');
        }
    }
    
    function endSelection() {
        if (confirm(`End vacation selection permanently?\n\nYou will NOT be contacted for future rounds.`)) {
            processAction('end');
        }
    }
    
    function processAction(action) {
        let emailBody, subject;
        
        if (action === 'skip') {
            subject = `Vacation Selection SKIPPED - ${employeeData.name} - Round ${employeeData.round}`;
            emailBody = `VACATION_SKIP%0D%0AName: ${employeeData.name}%0D%0ARound: ${employeeData.round}%0D%0AAction: Skipped%0D%0A%0D%0AEmployee chose to skip this round.`;
        } else {
            subject = `Vacation Selection ENDED - ${employeeData.name}`;
            emailBody = `VACATION_END%0D%0AName: ${employeeData.name}%0D%0ARound: ${employeeData.round}%0D%0AAction: Ended%0D%0A%0D%0AEmployee chose to end all future vacation selections.`;
        }
        
        const adminEmail = 'kirk.stringer@blood.ca';
        const fullText = `To: ${adminEmail}\nSubject: ${subject}\n\n${emailBody.replace(/%0D%0A/g, '\n')}`;
        
        if (navigator.clipboard) {
            navigator.clipboard.writeText(fullText).then(() => {
                alert(`${action === 'skip' ? 'Skip' : 'End'} selection copied to clipboard. Paste into a new email to ${adminEmail}`);
            });
        } else {
            alert(`Copy this text and email to ${adminEmail}:\n\n${fullText}`);
        }
    }
    
    function renderCalendar() {
        console.log('renderCalendar called');
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        
        document.getElementById('monthTitle').textContent = `${monthNames[currentMonth]} ${currentYear}`;
        
        dayNames.forEach(day => {
            const header = document.createElement('div');
            header.className = 'calendar-header';
            header.textContent = day;
            grid.appendChild(header);
        });
        
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        
        for (let i = 0; i < firstDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day disabled';
            grid.appendChild(emptyDay);
        }
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            
            const dateString = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const bookedCount = availability[dateString] || 0;
            const maxPerDay = employeeData.unionMaxPerDay;
            
            // Check if this is a work day for this employee
            const isWorkDay = employeeSchedule.includes(dateString);
            
            // Apply color classes based on work day status and booking count
            if (isWorkDay) {
                // Work day colors
                if (bookedCount >= maxPerDay) {
                    dayElement.classList.add('work-full');
                } else if (bookedCount > 0) {
                    dayElement.classList.add('work-partial');
                } else {
                    dayElement.classList.add('work-empty');
                }
            } else {
                // Non-work day colors
                if (bookedCount >= maxPerDay) {
                    dayElement.classList.add('nonwork-full');
                } else if (bookedCount > 0) {
                    dayElement.classList.add('nonwork-partial');
                } else {
                    dayElement.classList.add('nonwork-empty');
                }
            }
            
            if (selectedDates.includes(dateString)) {
                dayElement.classList.add('selected');
            }
            
            dayElement.innerHTML = `
                <div>${day}</div>
                <div style="font-size: 10px;">${bookedCount}/${maxPerDay}</div>
            `;
            
            dayElement.addEventListener('click', () => selectDate(dateString, dayElement, isWorkDay));
            grid.appendChild(dayElement);
        }
    }
    
    function selectDate(dateString, element, isWorkDay) {
        // Only block if it's a FULL WORK DAY
        if (element && element.classList.contains('work-full')) {
            alert('This work day is fully booked!');
            return;
        }
        
        if (selectedDates.length === 0) {
            selectedDates.push(dateString);
        } else if (selectedDates.length === 1) {
            const start = new Date(selectedDates[0]);
            const end = new Date(dateString);
            
            if (end < start) {
                selectedDates = [dateString, selectedDates[0]];
            } else {
                selectedDates.push(dateString);
            }
            
            fillConsecutiveDates();
        } else {
            selectedDates = [dateString];
        }
        
        renderCalendar();
        updateSelectionSummary();
    }
    
    function fillConsecutiveDates() {
        const start = new Date(selectedDates[0]);
        const end = new Date(selectedDates[selectedDates.length - 1]);
        const range = [];
        const maxPerDay = employeeData.unionMaxPerDay;
        
        let current = new Date(start);
        while (current <= end) {
            const dateStr = current.toISOString().split('T')[0];
            const booked = availability[dateStr] || 0;
            const isWorkDay = employeeSchedule.includes(dateStr);
            
            // Only block if it's a full WORK day
            if (isWorkDay && booked >= maxPerDay) {
                alert(`Cannot select range: ${dateStr} is a fully booked work day.`);
                selectedDates = [];
                return;
            }
            
            range.push(dateStr);
            current.setDate(current.getDate() + 1);
        }
        
        // Count only work days for vacation limit
        const workDaysInRange = countWorkDaysInSelection(range);
        
        if (workDaysInRange > employeeData.availableDays) {
            alert(`Selection includes ${workDaysInRange} work days but you only have ${employeeData.availableDays} vacation days remaining.`);
            selectedDates = [];
            return;
        }
        
        selectedDates = range;
    }
    
    function updateSelectionSummary() {
        const summary = document.getElementById('selectionSummary');
        
        if (selectedDates.length === 0) {
            summary.style.display = 'none';
            document.getElementById('submitBtn').disabled = true;
            return;
        }
        
        const workDays = countWorkDaysInSelection(selectedDates);
        
        summary.style.display = 'block';
        document.getElementById('submitBtn').disabled = false;
        
        document.getElementById('startDate').textContent = new Date(selectedDates[0]).toLocaleDateString();
        document.getElementById('endDate').textContent = new Date(selectedDates[selectedDates.length - 1]).toLocaleDateString();
        document.getElementById('totalDays').textContent = `${selectedDates.length} total (${workDays} work days)`;
        document.getElementById('remainingDays').textContent = employeeData.availableDays - workDays;
    }
    
    function previousMonth() {
        if (currentMonth === 0) {
            currentMonth = 11;
            currentYear--;
        } else {
            currentMonth--;
        }
        renderCalendar();
    }
    
    function nextMonth() {
        if (currentMonth === 11) {
            currentMonth = 0;
            currentYear++;
        } else {
            currentMonth++;
        }
        renderCalendar();
    }
    
    function submitSelection() {
        if (selectedDates.length === 0) {
            alert('Please select your vacation dates first.');
            return;
        }
        
        const startDate = selectedDates[0];
        const endDate = selectedDates[selectedDates.length - 1];
        const totalDays = selectedDates.length;
        const workDays = countWorkDaysInSelection(selectedDates);
        
        const emailBodyText = `VACATION_SELECTION
Name: ${employeeData.name}
Start: ${startDate}
End: ${endDate}
Days: ${totalDays}
Work Days: ${workDays}
Round: ${employeeData.round}

This is an automated vacation selection submission.`;
        
        const emailSubject = `Vacation Selection - ${employeeData.name} - Round ${employeeData.round}`;
        const adminEmail = 'kirk.stringer@blood.ca';
        const fullText = `To: ${adminEmail}\nSubject: ${emailSubject}\n\n${emailBodyText}`;
        
        if (confirm(`You selected:\n\nStart: ${new Date(startDate).toLocaleDateString()}\nEnd: ${new Date(endDate).toLocaleDateString()}\nTotal Days: ${totalDays}\nWork Days: ${workDays}\n\nCopy email text to clipboard?`)) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(fullText).then(() => {
                    alert('Email text copied to clipboard. Paste into a new email to send your selection.');
                });
            } else {
                alert(`Copy this text and email to ${adminEmail}:\n\n${fullText}`);
            }
        }
    }
</script>
